<!DOCTYPE html>
<html lang="en" class="custom-theme">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theme Store</title>
    <link rel="stylesheet" href="/assets/index.css">
    <link rel="icon" href="/assets/BetterRHLogo.png">
</head>

<body>
    <div id="toolbar" autofocus="" role="banner" narrow-threshold="980">
        <div id="leftContent">
            <div id="leftSpacer">
                <slot name="product-logo">
                    <picture>
                        <source media="(prefers-color-scheme: dark)" srcset="/assets/Logo.svg">
                        <img id="product-logo" src="/assets/Logo.svg" role="presentation">
                    </picture>
                </slot>
                <h1>Themes</h1>
            </div>
        </div>
        <div id="centeredContent">
            <div id="search" label="Search settings" clear-label="Clear search" autofocus="" icon-override=""
                input-aria-description="">
                <div id="background"></div>
                <div id="stateBackground"></div>
                <div id="content">
                    <div id="icon-button" title="Search themes" tabindex="-1" aria-hidden="true" role="button"
                        aria-disabled="false">
                        <div id="icon">
                            <div id="maskedImage"></div>
                            <div id="rhicon">
                                <svg id="baseSvg" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet"
                                    focusable="false"
                                    style="pointer-events: none; display: block; width: 100%; height: 100%;"
                                    viewBox="0 0 24 24" class="cr-iconset-svg-icon_" role="none">
                                    <g>
                                        <path
                                            d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z">
                                        </path>
                                    </g>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div id="searchTerm">
                        <label id="prompt" for="searchInput" aria-hidden="true">
                            Search themes
                        </label>
                        <input id="searchInput" aria-labelledby="prompt" autocapitalize="off" autocomplete="off"
                            type="search" spellcheck="false" aria-description="" autofocus="">
                    </div>
                    <div id="icon-button" title="Clear search" role="button" tabindex="0" aria-disabled="false" class="searchClear hidden">
                        <div id="icon">
                            <div id="maskedImage"></div>
                            <div id="rhicon">
                                <svg id="baseSvg" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet"
                                    focusable="false"
                                    style="pointer-events: none; display: block; width: 100%; height: 100%;"
                                    viewBox="0 0 24 24" class="cr-iconset-svg-icon_" role="none">
                                    <g>
                                        <path
                                            d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z">
                                        </path>
                                    </g>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="rightContent">
            <div id="rightSpacer">
                <slot></slot>
            </div>
        </div>
    </div>
    <script>
        const searchInput = document.querySelector("#searchTerm > #searchInput");
        const searchBar = document.querySelector("#centeredContent > #search");
        const searchPlaceholder = document.querySelector("#searchTerm > #prompt");
        const searchClear = document.querySelector("#content > .searchClear");
        searchInput.addEventListener("input", function() {
            if (searchInput.value) {
                searchPlaceholder.classList.add("hidden");
                searchClear.classList.remove("hidden");
                const oldUrl = new URL(location.href);
                oldUrl.searchParams.set("q", searchInput.value);
                history.pushState(null, "", oldUrl);
            } else {
                searchPlaceholder.classList.remove("hidden");
                searchClear.classList.add("hidden");
                const oldUrl = new URL(location.href);
                oldUrl.searchParams.delete("q");
                history.pushState(null, "", oldUrl);
            }
        })

        searchClear.addEventListener("click", function() {
            searchInput.value = "";
            searchInput.dispatchEvent(new Event("input"));
            const oldUrl = new URL(location.href);
            oldUrl.searchParams.delete("q");
            history.pushState(null, "", oldUrl);
        });

        document.addEventListener("click", function() {
            if (document.activeElement === searchInput) {
                searchBar.classList.add("active");
            } else {
                searchBar.classList.remove("active");
            }
        })

        window.addEventListener("load", function() {
            const searchParams = new URLSearchParams(location.search);
            if (searchParams.has("q")) {
                searchInput.value = searchParams.get("q");
                searchPlaceholder.classList.add("hidden");
                searchClear.classList.remove("hidden");
            }
        })
    </script>
    <script>
        const burstSandbox = function () {
            // Rammerhead Clients usually have %hammerhead%
            console.debug("Bursting Rammerhead Sandbox");
            return Function("const Func = window[`%hammerhead%`].nativeMethods.Function; return Func(`return window.top`)();")();
        }

        let windowethToppeth;

        try {
            windowethToppeth = burstSandbox();
        } catch {
            if (window["%hammerhead%"]) console.warn("Rammerhead Sandbox Breakout failed");
        }

        const openExternalLink = function (url) {
            return windowethToppeth[`open`](url);
        };

        const openBrowserLink = function (url, newTab = true) {
            if ("BetterRH" in windowethToppeth) {
                return windowethToppeth.BetterRH.executeSearch(url, newTab);
            }
        }
        
        const themeSettingsPage = function (url) {
            Array.from(document.querySelectorAll("link.user-theme")).map(e => e.remove());
            const newTheme = document.createElement("link");
            newTheme.rel = "stylesheet";
            newTheme.href = url;
            newTheme.className = "user-theme";
            document.head.appendChild(newTheme);
        }

        const getQueryParams = function () {
            return Object.fromEntries(window.location.search.slice(1).split("&").map(e => e.split("=")));
        }

        const isTrue = function (_) {
            if (_ instanceof Array) return (_.length > 0);
            if (_ instanceof Object) return true;
            if (typeof _ === "boolean") return _;
            return (_ === "true" || _ === "yes" || parseInt(_) >= 1 || parseInt(_) >= "1");
        }

        window.toggleTheme = function(_) {
            if (!window["%is-hammerhead%"]) return;
            if (!windowethToppeth) return;
            try {
                if (windowethToppeth.rhTheming) {
                    windowethToppeth.rhTheming.setEnabled(_);
                    windowethToppeth.rhTheming.setURL(_);
                    return _;
                } else if (windowethToppeth.toggleTheme) {
                    windowethToppeth.toggleTheme(_);
                    return _;
                }
            } catch (_) {
            return null;
            }
        };

        window.addEventListener("themeState", ({themeState}) => {
            if (themeState) {
                if (themeState.theme) {
                    if (themeState.theme.startsWith("rh://")) {
                        themeSettingsPage(null);
                    } else {
                        themeSettingsPage(themeState.theme);
                    }
                }
                if (!!themeState.active) {
                    console.log("Dark Mode: Active")
                } else {
                    console.log("Dark Mode: Inactive")
                }
            }
        })

        window.addEventListener("load", () => {
            // Continue with Checking for Rammerhead
            if (!window["%is-hammerhead%"]) return;
            if (!windowethToppeth) return;
            if (windowethToppeth.location.href === "about:blank") return;
            if (!windowethToppeth.BetterRH) {
                console.log("No Better Rammerhead!")
            } else {
                windowethToppeth.dispatchEvent(new CustomEvent("requestThemeConfig"));
            }
        })
    </script>
    <div id="storeContent"></div>
    <template id="theme-template">
        <div id="card">
            <div id="main">
                <div id="icon-wrapper">
                    <img id="icon" alt="Theme Icon" src="">
                </div>
                <div id="content">
                    <div>
                        <div id="name-and-version">
                            <div id="name" role="heading">
                                Theme Name
                            </div>
                            <span id="version">
                                0.0.0
                            </span>
                        </div>
                    </div>
                    <div id="description">
                        Script Description
                    </div>
                    <div id="actions">
                        <div id="install">
                            <svg title="Install Theme" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">
                                <path d="M320-120v-80H160q-33 0-56.5-23.5T80-280v-480q0-33 23.5-56.5T160-840h320v80H160v480h640v-120h80v120q0 33-23.5 56.5T800-200H640v80H320Zm360-280L480-600l56-56 104 103v-287h80v287l104-103 56 56-200 200Z"/>
                            </svg>
                            Install Theme
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <script>       
        function generateTextIcon(initial) {
            const canvas = document.createElement(`canvas`);
            canvas.width = 96;
            canvas.height = 96;
            const ctx = canvas.getContext("2d");
            ctx.fillStyle = "#ffdf8c";
            ctx.roundRect(0, 0, 96, 96, 10);
            ctx.fill();
            ctx.fillStyle = "#000000";
            ctx.font = "40px sans-serif";
            const text = initial;
            const textWidth = ctx.measureText(text);
            ctx.fillText(text, (canvas.width/2) - (textWidth.width/2), canvas.height / 2 + (textWidth.actualBoundingBoxAscent - textWidth.actualBoundingBoxDescent) / 2);
            return canvas.toDataURL("png");
        }

        function makeThemeCard(name = "Unnamed Theme", description, version = "Unknown", icon, metadata = {}) {
            const cardElement = document.querySelector(`template#theme-template`).content.cloneNode(true);
            const cardIcon = cardElement.querySelector(`#icon-wrapper > #icon[src]`);
            const cardName = cardElement.querySelector(`#name-and-version > #name`);
            const cardVersion = cardElement.querySelector(`#name-and-version > #version`);
            const cardDescription = cardElement.querySelector(`#content > #description`);
            const cardInstall = cardElement.querySelector(`#content > #actions > #install`);
        
            cardName.innerText = name;
            cardVersion.innerText = version;
            if (description) {
                cardDescription.innerText = description;
            };
            if (icon) {
                cardIcon.src = icon;
            } else {
                cardIcon.src = generateTextIcon(name.split("").find(e => e.match(/[a-z0-9]/gmi)));
            };
            cardInstall.addEventListener("click", async function() {
                console.log("Installing:", metadata?.src);
                window.toggleTheme(metadata?.src);
            })
            return cardElement;
        }
    </script>
    <script>
        window.addEventListener("load", async function() {
            Array.from(document.querySelector(`#storeContent`).childNodes).forEach(e => e.remove());
            window.themeList = await fetch("/data/themes.json").then(resp => resp.json()).catch(() => []);
            for (const theme of window.themeList) {
                document.querySelector(`#storeContent`).appendChild(makeThemeCard(theme?.name, theme?.description, theme?.version, null, {
                    src: theme?.src
                }))
            }

            navigation.addEventListener("navigate", function(event) {
                Array.from(document.querySelector(`#storeContent`).childNodes).forEach(e => e.remove());
                const searchQuery = new URL(event.destination.url).searchParams.get("q") || null;
                if (!searchQuery) {
                    for (const theme of window.themeList) {
                        document.querySelector(`#storeContent`).appendChild(makeThemeCard(theme?.name, theme?.description, theme?.version, null, {
                            src: theme?.src
                        }))
                    }
                } else {
                    const filteredThemes = window.themeList.filter(e => ((e?.name?.includes?.(searchQuery) || e?.description?.includes?.(searchQuery) || e?.author?.includes?.(searchQuery)) || (e?.name?.toLowerCase?.().includes?.(searchQuery.toLowerCase()) || e?.description?.toLowerCase?.().includes?.(searchQuery.toLowerCase()) || e?.author?.toLowerCase?.().includes?.(searchQuery.toLowerCase()))));
                    for (const theme of filteredThemes) {
                        document.querySelector(`#storeContent`).appendChild(makeThemeCard(theme?.name, theme?.description, theme?.version, null, {
                            src: theme?.src
                        }))
                    }
                }
                
            })
        })
    </script>
</body>

</html>
