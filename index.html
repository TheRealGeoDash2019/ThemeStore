<!DOCTYPE html>
<html lang="en" class="custom-theme">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theme Store</title>
    <link rel="stylesheet" href="/assets/index.css">
    <link rel="icon" href="/assets/BetterRHLogo.png">
</head>

<body>
    <div id="toolbar" autofocus="" role="banner" narrow-threshold="980">
        <div id="leftContent">
            <div id="leftSpacer">
                <slot name="product-logo">
                    <picture>
                        <source media="(prefers-color-scheme: dark)" srcset="/assets/Logo.svg">
                        <img id="product-logo" src="/assets/Logo.svg" role="presentation">
                    </picture>
                </slot>
                <h1>Themes</h1>
            </div>
        </div>
        <div id="centeredContent">
            <div id="search" label="Search settings" clear-label="Clear search" autofocus="" icon-override=""
                input-aria-description="">
                <div id="background"></div>
                <div id="stateBackground"></div>
                <div id="content">
                    <div id="icon-button" title="Search themes" tabindex="-1" aria-hidden="true" role="button"
                        aria-disabled="false">
                        <div id="icon">
                            <div id="maskedImage"></div>
                            <div id="rhicon">
                                <svg id="baseSvg" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet"
                                    focusable="false"
                                    style="pointer-events: none; display: block; width: 100%; height: 100%;"
                                    viewBox="0 0 24 24" class="cr-iconset-svg-icon_" role="none">
                                    <g>
                                        <path
                                            d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z">
                                        </path>
                                    </g>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div id="searchTerm">
                        <label id="prompt" for="searchInput" aria-hidden="true">
                            Search themes
                        </label>
                        <input id="searchInput" aria-labelledby="prompt" autocapitalize="off" autocomplete="off"
                            type="search" spellcheck="false" aria-description="" autofocus="">
                    </div>
                    <div id="icon-button" title="Clear search" role="button" tabindex="0" aria-disabled="false" class="searchClear hidden">
                        <div id="icon">
                            <div id="maskedImage"></div>
                            <div id="rhicon">
                                <svg id="baseSvg" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet"
                                    focusable="false"
                                    style="pointer-events: none; display: block; width: 100%; height: 100%;"
                                    viewBox="0 0 24 24" class="cr-iconset-svg-icon_" role="none">
                                    <g>
                                        <path
                                            d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z">
                                        </path>
                                    </g>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="rightContent">
            <div id="rightSpacer">
                <slot></slot>
            </div>
        </div>
    </div>
    <script>
        const searchInput = document.querySelector("#searchTerm > #searchInput");
        const searchBar = document.querySelector("#centeredContent > #search");
        const searchPlaceholder = document.querySelector("#searchTerm > #prompt");
        const searchClear = document.querySelector("#content > .searchClear");
        searchInput.addEventListener("input", function() {
            if (searchInput.value) {
                searchPlaceholder.classList.add("hidden");
                searchClear.classList.remove("hidden");
                const oldUrl = new URL(location.href);
                oldUrl.searchParams.set("q", searchInput.value);
                history.pushState(null, "", oldUrl);
            } else {
                searchPlaceholder.classList.remove("hidden");
                searchClear.classList.add("hidden");
                const oldUrl = new URL(location.href);
                oldUrl.searchParams.delete("q");
                history.pushState(null, "", oldUrl);
            }
        })

        searchClear.addEventListener("click", function() {
            searchInput.value = "";
            searchInput.dispatchEvent(new Event("input"));
            const oldUrl = new URL(location.href);
            oldUrl.searchParams.delete("q");
            history.pushState(null, "", oldUrl);
        });

        document.addEventListener("click", function() {
            if (document.activeElement === searchInput) {
                searchBar.classList.add("active");
            } else {
                searchBar.classList.remove("active");
            }
        })
    </script>
    <script>
        const burstSandbox = function () {
            // Rammerhead Clients usually have %hammerhead%
            console.debug("Bursting Rammerhead Sandbox");
            return Function("const Func = window[`%hammerhead%`].nativeMethods.Function; return Func(`return window.top`)();")();
        }

        let windowethToppeth;

        try {
            windowethToppeth = burstSandbox();
        } catch {
            if (window["%hammerhead%"]) console.warn("Rammerhead Sandbox Breakout failed");
        }

        const openExternalLink = function (url) {
            return windowethToppeth[`open`](url);
        };

        const openBrowserLink = function (url, newTab = true) {
            if ("BetterRH" in windowethToppeth) {
                return windowethToppeth.BetterRH.executeSearch(url, newTab);
            }
        }
        
        const themeSettingsPage = function (url) {
            Array.from(document.querySelectorAll("link.user-theme")).map(e => e.remove());
            const newTheme = document.createElement("link");
            newTheme.rel = "stylesheet";
            newTheme.href = url;
            newTheme.className = "user-theme";
            document.head.appendChild(newTheme);
        }

        const getQueryParams = function () {
            return Object.fromEntries(window.location.search.slice(1).split("&").map(e => e.split("=")));
        }

        const isTrue = function (_) {
            if (_ instanceof Array) return (_.length > 0);
            if (_ instanceof Object) return true;
            if (typeof _ === "boolean") return _;
            return (_ === "true" || _ === "yes" || parseInt(_) >= 1 || parseInt(_) >= "1");
        }

        window.addEventListener("themeState", ({themeState}) => {
            if (themeState) {
                if (themeState.theme) {
                    if (themeState.theme.startsWith("rh://")) {
                        themeSettingsPage(null);
                    } else {
                        themeSettingsPage(themeState.theme);
                    }
                }
                if (!!themeState.active) {
                    console.log("Dark Mode: Active")
                } else {
                    console.log("Dark Mode: Inactive")
                }
            }
        })

        window.addEventListener("load", () => {
            // Continue with Checking for Rammerhead
            if (!window["%is-hammerhead%"]) return;
            if (!windowethToppeth) return;
            if (windowethToppeth.location.href === "about:blank") return;
            if (!windowethToppeth.BetterRH) {
                console.log("No Better Rammerhead!")
            } else {
                windowethToppeth.dispatchEvent(new CustomEvent("requestThemeConfig"));
            }
        })
    </script>
    <div id="storeContent"></div>
</body>

</html>
